
---
title: "gatars version 0.2.12"
author: ''
output:
  html_document:
    css: ~/Documents/headings.css
    fig_caption: yes
    highlight: default
    number_sections: yes
    theme: readable
    toc: yes
  pdf_document:
    highlight: tango
    number_sections: yes
    pandoc_args: --variable=geometry:margin=0.75in
    toc: yes
fontsize: 12pt
---
<A NAME="top"> </A>
```{r global_options, include=FALSE}
require(knitr)
opts_chunk$set(eval = TRUE, echo = TRUE, fig.height = 5, fig.width = 8, tidy=FALSE)
```

"2017-11-09 09:36:00 PST"

# Introduction {#intro}

For comments or questions, please contact Gail Gong at gailgongster@gmail.com

`gatars` is an acronym for "Genetic Association Tests for Arbitrarily Related Subjects"

`gatars` tests the association between a specified set of $M$ genetic markers, called target 
markers, and a binary or quantitative trait using subjects with any genealogical 
relationship. The goal is to test the null hypothesis of no association between trait and 
genotypes at the M target markers.  We condition on trait phenotypes and treat genotypes
as random.  Test statistics include three "basic" statistics--the squared burden statistic $Q_B$,
the sequence kernel association test (SKAT) statistic $Q_S$, and a new trait-based kernel
statistic $Q_T$--as well as an ensemble of four statistics $Q_{BS}$, $Q_{BT}$, $Q_{ST}$, $Q_{BST}$ that optimize
linear combinations of the three basic statistics.  All seven statistics are summarized in 
Table 1 of the manuscript.

The test statistics use obervations on $N$ subjects, who are sampled based on their
phenotypes $y_n$ for a binary or quantitative trait, $n = 1, \cdots, N$.  The calculations require for
each subject a vector $g_n = \big(g_{n1}, \cdots, g_{nM} \big)$ of coded genotypes at $M$ target markers, and a
user-specified null trait prediction $\mu_n$ (for example $\mu_n$ can be the mean of the $N$ $y_n$ values
or the value predicted from a logistic or linear regression of $y_n$ on nongenetic covariates
and/or on principal components of ancestry.)  Define the genotype matrix to be the $N \times M$
matrix $G$ whose $(n,m)$-th component is the genotype $g_{nm}$ of the $n$-th subject at the $m$-th 
target marker.

The test statistics account for covariances among the components of $G$.  For pairwise 
intermarker covariances (summarized by the $M \times M$ matrix $\Gamma$ in the manuscript) `gatars` uses the
empirical covariances based on the genotypes of the $N$ subjects.  The user must provide the
pairwise inter-personal correlation coefficients (summarized by the $N \times N$ matrix $\Psi$ in the
manuscript).

Testing the null hypothesis for the optimized statistics requires resampling from sets of
markers located throughout the autosomal genome. `gatars` needs $M$ sampling sets, one for 
each target marker, with the sampling set for the $m$-th target marker containing markers
all of whose minor allele frequencies (MAFs) match that of target marker $m$.  The markers in
the sampling sets should be independent of the target markers and of any markers known
to be associated with the trait.  `gatars` can create these sampling sets provided the user
supplies two data sets containing: (1) the $N$ subjects' genotypes at roughly 100,000
markers located thoughout the autosomal genome; (2) the bp positions of any autosomal 
markers known to be trait-assoicated.  `gatars` creates the sampling sets by dividing the
human autosome into independent segments using the recombination hotspots identified
by Myers et al (2005).  To do so, `gatars` has translated the base-pair positions of these 
recombination hotspots to Build hg38/GRCh38.

[TOP](#top)

# Installing `gatars` {#install-gatars}

If you have not yet installed R, download the latest version (at least 3.2.4) for your operating system at:

http://www.r-project.org

Run the R application. To install the `gatars` package, enter the following lines of code to the R prompt:

```
install.packages("devtools")
library(devtools)
install_github("gailg/gatars")
if("gatars" %in% rownames(installed.packages())){
  print("gatars installed successfully--you are good to go!")
} else {
  print("something went wrong--ask for help")
}
```
If your installation was successful, you should see the message

```
[1] "gatars installed successfully--you are good to go!"
```

[TOP](#top)

# Data required {#data-required}

`gatars` requires quite large amounts of data, and typically, which can be organized in Plink (http://pngu.mgh.harvard.edu/~purcell/plink/).  We assume that you can bring your data into R and create the following six data sets.

## `bim`

A `data.frame` containing the three columns `chromosome`, `snp`, `bp`, and 
containing $L$ rows corresponding to the $M$ target markers and those used to build the
sampling sets.  The $l$-th row of `bim` summarizes the $l$-th marker and corresponds to the $l$-th column of `genotype` (described below). The column labeled `chromosome` contains integers between $1$ and $22$ (other integers may be included, but only chromosomes $1$ through $22$ will be used), the `snp` column contains character strings that name the marker, and the `bp` column contains integers giving the markers' bp positions.  (Because the `gatars` data set `hotspot` (described below) is given in Build hg38/GRCh38, `bp` must also be expressed in Build hg38/GRCh38.) 

## `genotype`

An $N \times L$ matrix, whose $(n,l)$-th element records the $n$-th subject's coded genotype at the $l$-th
of $L$ markers. The $l$-th column of `genotype` corresponds to the $l$-th row of `bim`.  The object
`genotype` could be obtained by reading in the `.bed` file from plink.  (Here we distinguish
`genotype` (the $N \times L$ matrix whose columns correspond to the $M$ target markers AND the
additional $L - M$ potential sampling set markers) from the $N \times M$ matrix $G$, described in the manuscript, containing just the $M$ target 
markers).

## `target_markers`

A character vector that is a subset of the column `bim$snp`.  This vector identifies the target markers.

## `phenotype`

A `data.frame` containing $N$ rows and the two columns `y` and `mu` where `y` contains the subjects' coded phenotypes (either `0` or `1` if the trait is binary or a real number if the trait is quantitative) and where `mu` contains the user-specified null trait prediction (a real number) for $y$.

## `Psi` = $\Psi$

`Psi` is the $N \times N$ matrix of user-specified null correlation coefficients between pairs of subjects
at any marker.  `Psi` can be estimated using known family pedigree structures and/or from the
subjects' genotypes at markers independent of those in the target set in software packages
such as KING (Manichaikul et al 2010).


## `exclusion_region`

A `data.frame` with one or several rows of the three columns `chromosome`, `start`, and `end`. 
Each row of this `exclusion_region` reflects one contiguous genomic region known to 
be trait-associated and therefore a region used by `gatars` when creating the sampling sets.
The column `chromosome` is an integer between `1` and `22` identifying the autosomal
chromosome containing the region, and `start` and `end` describe its starting and ending 
positions (bp).  If the region consists of a single marker, then `start` and `end` are both equal 
to the position of this marker.  `start` and `end` must be expressed in Build hg38/GRCh38.

In addition, the `gatars` package provides the data set `hotspot` for your convenience.
`hotspot contains the columns `chromosome`, `start`, and `end`. `chromosome` gives the 
chromosome (an integer between $1$ and $22$) containing a given recombination hotspot; 
`start` and `end` give the extent of the recombination
hotspot (integers reflecting their Build hg38/GRCh38 bp positions).

[TOP](#top)

# An example data set {#example-data-set}

For illustration I will now use the example data set provided by `gatars`.
You can access this example data with the following commands.

```{r}
library(gatars)
# Preparing the data
bim = gatars_example$bim
exclusion_region = gatars_example$exclusion_region
genotype = gatars_example$genotype
phenotype = gatars_example$phenotype
Psi = gatars_example$Psi
target_markers = gatars_example$target_markers[3:5]
```

## `bim` has `r nrow(bim)` rows and includes the columns `chromosome`, `snp`, and  `bp`

```{r}
str(bim)
```

## `genotype` has `r nrow(genotype)` rows and `r ncol(genotype)` columns

I chose a relatively small number of columns to keep the example small.

```{r}
str(genotype)
```

The column names of `genotype` must match `bim$snp`:

```{r}
all(colnames(genotype) == bim$snp)
```

## `target_markers` is a character vector containing `r length(target_markers)` names

```{r}
str(target_markers)
```

The elements in `target_markers` must be included in `bim$snp`

```{r}
all(target_markers %in% bim$snp)
```

## `phenotype` has `r nrow(phenotype)` rows and includes the columns `y` and `mu`

```{r}
str(phenotype)
```

## `Psi` is a `r nrow(Psi)` $\times$ `r nrow(Psi)`  square matrix

```{r}
str(Psi)
```

The following figure reflects the fact that the first `100` people are made up of `50` sib pairs, and the last `100` people are independent.

```{r Psi_picture, fig.height = 4, fig.width = 5}
# figure to illustrate Psi
NNN = nrow(phenotype)
first_ten = 1:10
last_ten = NNN - (9:0)
matrix_image_fn(Psi[c(first_ten, last_ten), c(first_ten, last_ten)],
                main = "First and last 10 rows and columns of Psi")
```


## `exclusion_region` is a `data.frame` containing  the columns `chromosome`, `start`, and `end`

```{r}
str(exclusion_region)
```

## `hotspot` is available as soon as you enter `gatars`:

```{r}
str(hotspot)
```


# Check that your genotype matrix has rank $M$

`genotype_target_markers` is the $N \times M$ genotype matrix.

```{r}
# Checking the rank of the genotype_target_markers matrix
library(Matrix)
genotype_target_markers = genotype[, target_markers]
list(target_markers = target_markers,
     rank = as.numeric(rankMatrix( genotype_target_markers)))
```

# gatars-sampling-set {#gatars-sampling-set}

Once you have your data in R, and you have checked that the column rank of your genotype matrix $G =$ `genotype_target_markers` is $M$, use the function `gatars_sampling_set`  to create your sampling sets. 

## A description of how `gatars_sampling_set` builds the sampling sets

Each column in `genotype` corresponds to a row in `bim`, and both correspond to a marker. After removing the target markers, we want to use the remaining markers to form $M$ sampling sets, one for each of the target markers. The two requirements for the markers in a sampling set are: 1) that they have MAFs matching that of the target marker; and 2) that they are independent of all target markers and all markers known to be trait-associated.

Assuming that markers within two consecutive hotspots are independent of those within any other two consecutive hotspots, 
the recombination hotspots divide the autosomal genome into independent segments.  Remove all segments containing any target markers or any markers defined by the `exclusion_region` data set. On the markers in the remaining segments, calculate the empirical MAFs and say that a marker's MAF matches the MAF $\pi_m$ of the $m$-th target marker if it is within
$\pi_m \times \big[1 -$ `epsilon` $, 1 +$ `epsilon` $\big]$.  If the number of markers satisfying the matching requirement exceeds `1000`, `gatars` randomly chooses `1000`.


## The arguments of `gatars_sampling_set`

The following is the function header of `gatars_sampling_set` showing which arguments are needed and in which order.

```
gatars_sampling_set(
  bim,
  epsilon,
  exclusion_region,
  genotype,
  hotspot,
  target_markers
)
```
### `bim`,  `exclusion_region`, `genotype`, `hotspot`, and `target_markers`,

These objects have already been discussed in [An example data set](#example-data-set).

### `epsilon` 

A positive small real number used to parametrize the matching.  When creating the $m$-th sampling set for target marker with minor allele frequency $\pi_m$, only those markers whose minor allele frequencies falling within the interval
$\pi_m \times \big[1 -$ `epsilon` $, 1 +$ `epsilon` $\big]$ 
can be included in the sampling set.

## Example calls to `gatars_sampling_set` 

```{r eval = TRUE}
# Example calls to gatars_sampling_set
set.seed(42)
epsilon = 0.01
exclusion_region = NULL
sampling_set = gatars_sampling_set(
  bim,
  epsilon,
  exclusion_region,
  genotype,
  hotspot,
  target_markers
)
print(sampling_set)
```

```{r eval = TRUE}
previous_sampling_set = sampling_set
set.seed(42)
exclusion_region = gatars_example$exclusion_region
head(exclusion_region)
sampling_set = gatars_sampling_set(
  bim,
  epsilon,
  exclusion_region,
  genotype,
  hotspot,
  target_markers
)
print(previous_sampling_set)
print(sampling_set)
```

[TOP](#top)

# `gatars`

## A description of `gatars`

Recall the notation from the manuscript: $G$ is the $N \times M$ genotype matrix of target markers, $y$ is the $N \times 1$ column vector of subjectsâ€™ coded trait phenotypes, and $\mu$ is the $N \times 1$ column vector of user-specified phenotype predictions. Any linear combination of the three basic statistics can be written as a quadratic form $Q(\alpha) = Z^T A(\alpha) Z$. Here $Z$ is a linear function of the two vectors $W G y$ and $W G \mu$, $W$ is a diagonal matrix whose user-specified diagonal components weight the target markers, $A(\alpha)$ is a square matrix that does not depend on $G$, and $\alpha = \big( \alpha_B, \alpha_S, \alpha_T \big)$  is a triple of coefficients that lie in the unit triangle shown in Figure 1 of the manuscript.  The limiting null distribution of $Z$ when $N$ is large is multivariate normal with mean and covariance matrix that involve the first two moments of $G$.

`gatars` calculates the P-values of the following seven statistics: the three
basic statistics given by the squared burden $Q_B$, the SKAT $Q_S$ and the
trait-based $Q_T$, and their four optimized linear combinations $Q_{BS}$, $Q_{BT}$, $Q_{ST}$,
$Q_{BST}$. The significance level of the three basic statistics can be calculated
using the `davies` function from the `CompQuadForm` package. However this function
cannot be used for the remaining four statistics, each of which is optimized to
produce the smallest P-value within specified constraints.  Instead, `gatars` estimates the
significance levels of these statistics using *"genome resampling"*, as outlined
below. (See the manuscript "Null distributions of test statistics" pp 4-5 and "B. Optimizing the data-adaptive statistics" pp 9-10 for details)

To estimate the limiting null distribution of an optimized $Q$-statistic, we 
simulate  many null versions of the $Q$-statistic corresponding to a large number 
$K$ of simulated null genotype matrices $\tilde{G}^{(1)}, \cdots, \tilde{G}^{(K)}$.  Specifically, for
each $k$,  we construct the $N \times M$ matrix $\tilde{G}^{(k)}$ by sampling one column from each
sampling set described in Section [gatars-sampling-set](#gatars-sampling-set).  Then, for the $k$-th
simulated matrix $\tilde{G}^{(k)}$, we find the linear combination $\alpha^{k}$  having minimal nominal
significance level $P_{\alpha^{k}}$  and store the transformed value $X_{\alpha^{k}} = - \text{log}_{10} \big( P_{\alpha^{k}} \big)$ . 
We repeat this
procedure $K$ times and estimate the significance level of the observed $Q$
statistic to be the proportion of the $K$ transformed values $\Big\{X_{\alpha^k} \Big\}_{k = 1, \cdots, K}$ that exceed the
observed transformed P-value corresponding to our $Q$ statistic.

## The arguments of `gatars`

The following is the function header of `gatars` showing which arguments are needed and in which order.

```
gatars(phenotype, Psi, sampling_set, N_simulated_nulls, weights)
```

### `phenotype` and `Psi` 

These objects have already been discussed in [An example data set](#example-data-set).

### `sampling_set` 

This object is the result of `gatars_sampling_set` and you may follow the example from [gatars-sampling-set](#gatars-sampling-set)

### `N_simulated_nulls =` $K$

A positive integer which specifies the number of simulated null genotype matrices to generate to determine the p-value of the optimized statistics.


### `weights`

A vector of length equal to $M$ the length of `target_markers`.  The entries in the vector are non-negative real numbers.  The size of the `m`-th entry reflects the importance of the `m`-th target marker. If `weights` is not specified, the `gatars` assumes you would like equal weights among the $M$ target markers.

[TOP](#top)

## Example calls to `gatars`




# All the code in one place

```{r eval = TRUE}
library(gatars)
# Preparing the data
bim = gatars_example$bim
exclusion_region = gatars_example$exclusion_region
genotype = gatars_example$genotype
phenotype = gatars_example$phenotype
Psi = gatars_example$Psi
target_markers = gatars_example$target_markers[3:5]

# figure to illustrate Psi
NNN = nrow(phenotype)
first_ten = 1:10
last_ten = NNN - (9:0)
matrix_image_fn(Psi[c(first_ten, last_ten), c(first_ten, last_ten)],
                main = "First and last 10 rows and columns of Psi")

# Checking the rank of the genotype_target_markers matrix
library(Matrix)
genotype_target_markers = genotype[, target_markers]
list(target_markers = target_markers,
     rank = as.numeric(rankMatrix( genotype_target_markers)))

# Example calls to gatars_sampling_set
set.seed(42)
epsilon = 0.01
exclusion_region = NULL
sampling_set = gatars_sampling_set(
  bim,
  epsilon,
  exclusion_region,
  genotype,
  hotspot,
  target_markers
)
print(sampling_set)

previous_sampling_set = sampling_set
set.seed(42)
exclusion_region = gatars_example$exclusion_region
head(exclusion_region)
sampling_set = gatars_sampling_set(
  bim,
  epsilon,
  exclusion_region,
  genotype,
  hotspot,
  target_markers
)
print(previous_sampling_set)
print(sampling_set)

# Calling gatars 
start = Sys.time()
set.seed(42)
gatars(phenotype, Psi, sampling_set, N_simulated_nulls = 100, weights = c(5, 3, 2))
elapsed_time = Sys.time() - start
paste("100 sim reps used", 
      round(elapsed_time, 1), attributes(elapsed_time)$units)

start = Sys.time()
set.seed(42)
gatars(phenotype, Psi, sampling_set, N_simulated_nulls = 1000, weights = c(5, 3, 2))
elapsed_time = Sys.time() - start
paste("1000 sim reps used", 
      round(elapsed_time, 1), attributes(elapsed_time)$units)

start = Sys.time()
set.seed(42)
gatars(phenotype, Psi, sampling_set, N_simulated_nulls = 2000, weights = c(5, 3, 2))
elapsed_time = Sys.time() - start
paste("2000 sim reps used", 
      round(elapsed_time, 1), attributes(elapsed_time)$units)
```










































